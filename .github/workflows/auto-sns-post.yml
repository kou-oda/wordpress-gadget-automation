name: SNS Auto Post

on:
  # WordPressæŠ•ç¨¿å¾Œã«å®Ÿè¡Œ
  workflow_run:
    workflows: ["WordPress Auto Post"]
    types:
      - completed
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      post_url:
        description: 'æŠ•ç¨¿ã™ã‚‹WordPressè¨˜äº‹ã®URL'
        required: true
      post_title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        required: true

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install tweepy

      - name: æœ€æ–°è¨˜äº‹ã‚’å–å¾—
        id: get_post
        run: |
          # WordPress REST APIã‹ã‚‰æœ€æ–°è¨˜äº‹ã‚’å–å¾—
          curl -s "${{ secrets.WP_SITE_URL }}/wp-json/wp/v2/posts?per_page=1&orderby=date" > latest_post.json

          # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’æŠ½å‡º
          TITLE=$(cat latest_post.json | python3 -c "import sys, json; print(json.load(sys.stdin)[0]['title']['rendered'])")
          LINK=$(cat latest_post.json | python3 -c "import sys, json; print(json.load(sys.stdin)[0]['link'])")

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT

      - name: X (Twitter)ã«æŠ•ç¨¿
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python3 << 'EOF'
          import tweepy
          import os

          # èªè¨¼
          client = tweepy.Client(
              consumer_key=os.environ['TWITTER_API_KEY'],
              consumer_secret=os.environ['TWITTER_API_SECRET'],
              access_token=os.environ['TWITTER_ACCESS_TOKEN'],
              access_token_secret=os.environ['TWITTER_ACCESS_SECRET']
          )

          # ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹
          title = "${{ steps.get_post.outputs.title }}"
          link = "${{ steps.get_post.outputs.link }}"

          tweet_text = f"""ğŸ”¥ æ–°ç€ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼

{title}

è©³ç´°ã¯ã“ã¡ã‚‰ğŸ‘‡
{link}

#ã‚¬ã‚¸ã‚§ãƒƒãƒˆ #ãƒ¬ãƒ“ãƒ¥ãƒ¼ #Amazon #ãƒ†ãƒƒã‚¯ãƒ¬ãƒ“ãƒ¥ãƒ¼
"""

          # 280æ–‡å­—åˆ¶é™ã‚’è€ƒæ…®
          if len(tweet_text) > 280:
              tweet_text = tweet_text[:270] + "...\n" + link

          # æŠ•ç¨¿
          response = client.create_tweet(text=tweet_text)
          print(f"âœ“ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿æˆåŠŸ: {response.data['id']}")
          EOF

      - name: æŠ•ç¨¿çµæœ
        if: success()
        run: |
          echo "âœ“ SNSæŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸ"
