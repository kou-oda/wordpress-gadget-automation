name: Scheduled Twitter Post

on:
  # 1æ—¥3å›å®Ÿè¡Œï¼ˆJST 10:00ã€15:00ã€20:00ï¼‰
  schedule:
    - cron: '0 1 * * *'   # UTC 1:00 = JST 10:00
    - cron: '0 6 * * *'   # UTC 6:00 = JST 15:00
    - cron: '0 11 * * *'  # UTC 11:00 = JST 20:00
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install tweepy requests

      - name: å…¬é–‹æ¸ˆã¿è¨˜äº‹ã‚’å–å¾—ã—ã¦Twitterã«æŠ•ç¨¿
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python3 << 'EOF'
          import tweepy
          import requests
          import os
          import random
          import json
          from datetime import datetime, timedelta

          # WordPress REST APIã‹ã‚‰å…¬é–‹æ¸ˆã¿è¨˜äº‹ã‚’å–å¾—
          wp_url = os.environ['WP_SITE_URL']
          response = requests.get(f"{wp_url}/wp-json/wp/v2/posts?status=publish&per_page=50&orderby=date")

          if response.status_code != 200:
              print(f"âŒ WordPressè¨˜äº‹ã®å–å¾—ã«å¤±æ•—: {response.status_code}")
              exit(1)

          all_posts = response.json()

          if not all_posts or len(all_posts) == 0:
              print("âŒ å…¬é–‹æ¸ˆã¿è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
              exit(1)

          print(f"âœ“ {len(all_posts)}ä»¶ã®å…¬é–‹æ¸ˆã¿è¨˜äº‹ã‚’å–å¾—ã—ã¾ã—ãŸ")

          # éå»10æŠ•ç¨¿ã®å±¥æ­´ã‚’å–å¾—ï¼ˆTwitter APIã‹ã‚‰ï¼‰
          try:
              client = tweepy.Client(
                  consumer_key=os.environ['TWITTER_API_KEY'],
                  consumer_secret=os.environ['TWITTER_API_SECRET'],
                  access_token=os.environ['TWITTER_ACCESS_TOKEN'],
                  access_token_secret=os.environ['TWITTER_ACCESS_SECRET']
              )

              # è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
              me = client.get_me()
              user_id = me.data.id

              # éå»10ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å–å¾—
              recent_tweets = client.get_users_tweets(
                  id=user_id,
                  max_results=10,
                  tweet_fields=['created_at', 'text']
              )

              # éå»10æŠ•ç¨¿ã«å«ã¾ã‚Œã‚‹URLã‚’æŠ½å‡º
              posted_urls = set()
              if recent_tweets.data:
                  for tweet in recent_tweets.data:
                      # ãƒ„ã‚¤ãƒ¼ãƒˆã‹ã‚‰URLã‚’æŠ½å‡º
                      import re
                      urls = re.findall(r'https?://[^\s]+', tweet.text)
                      posted_urls.update(urls)

              print(f"âœ“ éå»10æŠ•ç¨¿ã®URL: {len(posted_urls)}ä»¶")

          except Exception as e:
              print(f"âš  éå»ãƒ„ã‚¤ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—: {e}")
              posted_urls = set()

          # éå»10æŠ•ç¨¿ã«å«ã¾ã‚Œã¦ã„ãªã„è¨˜äº‹ã‚’é¸æŠ
          available_posts = []
          for post in all_posts:
              post_url = post['link']
              if post_url not in posted_urls:
                  available_posts.append(post)

          if not available_posts:
              print("âš  æŠ•ç¨¿å¯èƒ½ãªæ–°ã—ã„è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆéå»10æŠ•ç¨¿ã¨é‡è¤‡ï¼‰")
              # å…¨è¨˜äº‹ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡ã‚’è¨±å®¹ï¼‰
              available_posts = all_posts

          print(f"âœ“ æŠ•ç¨¿å¯èƒ½ãªè¨˜äº‹: {len(available_posts)}ä»¶")

          # ãƒ©ãƒ³ãƒ€ãƒ ã«1è¨˜äº‹é¸æŠ
          selected_post = random.choice(available_posts)
          title = selected_post['title']['rendered']
          link = selected_post['link']

          print(f"é¸æŠã•ã‚ŒãŸè¨˜äº‹: {title}")
          print(f"URL: {link}")

          # ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã‚’ç”Ÿæˆ
          tweet_text = f"""ğŸ”¥ ãŠã™ã™ã‚ã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼

{title}

è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã“ã¡ã‚‰ğŸ‘‡
{link}

#ã‚¬ã‚¸ã‚§ãƒƒãƒˆ #ãƒ¬ãƒ“ãƒ¥ãƒ¼ #Amazon #ãƒ†ãƒƒã‚¯ãƒ¬ãƒ“ãƒ¥ãƒ¼
"""

          # 280æ–‡å­—åˆ¶é™ã‚’è€ƒæ…®
          if len(tweet_text) > 280:
              # ã‚¿ã‚¤ãƒˆãƒ«ã‚’çŸ­ç¸®
              max_title_length = 280 - len(tweet_text) + len(title) - 10
              short_title = title[:max_title_length] + "..."
              tweet_text = f"""ğŸ”¥ ãŠã™ã™ã‚ã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼

{short_title}

è©³ç´°ã¯ã“ã¡ã‚‰ğŸ‘‡
{link}

#ã‚¬ã‚¸ã‚§ãƒƒãƒˆ #ãƒ¬ãƒ“ãƒ¥ãƒ¼ #Amazon
"""

          # æŠ•ç¨¿
          try:
              response = client.create_tweet(text=tweet_text)
              print(f"âœ“ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿æˆåŠŸ: {response.data['id']}")
              print(f"ãƒ„ã‚¤ãƒ¼ãƒˆURL: https://twitter.com/user/status/{response.data['id']}")
          except Exception as e:
              print(f"âŒ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ã«å¤±æ•—: {e}")
              exit(1)
          EOF

      - name: æŠ•ç¨¿çµæœ
        if: success()
        run: |
          echo "âœ“ TwitteræŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸ"
