name: bulk twitter post

on:
  # æ¯æœˆ3ã®å€æ•°ã®æ—¥ã«å®Ÿè¡Œï¼ˆJST 9:00ï¼‰
  # GitHub Actionsã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ: æœ‰åŠ¹
  # æ³¨æ„: cronæ§‹æ–‡ã§ã¯å³å¯†ãªã€Œ3æ—¥ã”ã¨ã€ã‚’è¡¨ç¾ã§ãã¾ã›ã‚“
  # ç¾åœ¨ã®è¨­å®š: æ¯æœˆ3, 6, 9, 12, 15, 18, 21, 24, 27, 30æ—¥ã«å®Ÿè¡Œï¼ˆç´„10å›/æœˆï¼‰
  schedule:
    - cron: '0 0 */3 * *'   # UTC 0:00 = JST 9:00ã€æ¯æœˆ3ã®å€æ•°ã®æ—¥
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'false'

jobs:
  bulk-post-to-twitter:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install tweepy requests

      - name: å…¨è¨˜äº‹ã‹ã‚‰å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã«50ä»¶å–å¾—ã—ã¦Twitterã«æŠ•ç¨¿
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python3 << 'EOF'
          import tweepy
          import requests
          import os
          import random

          wp_url = os.environ['WP_SITE_URL']

          # Step 1: ç·è¨˜äº‹æ•°ã‚’å–å¾—
          response = requests.get(f"{wp_url}/wp-json/wp/v2/posts?status=publish&per_page=1")
          if response.status_code != 200:
              print(f"âŒ WordPressè¨˜äº‹ã®å–å¾—ã«å¤±æ•—: {response.status_code}")
              exit(1)

          total_posts = int(response.headers.get('X-WP-Total', 0))
          print(f"âœ“ WordPressä¸Šã®å…¬é–‹æ¸ˆã¿è¨˜äº‹ç·æ•°: {total_posts}ä»¶")

          if total_posts == 0:
              print("âŒ å…¬é–‹æ¸ˆã¿è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
              exit(1)

          # Step 2: å…¨è¨˜äº‹ã‚’å–å¾—ï¼ˆWordPress REST APIã®åˆ¶é™: 100ä»¶/ãƒšãƒ¼ã‚¸ï¼‰
          all_posts = []
          per_page = 100
          pages = (total_posts + per_page - 1) // per_page  # åˆ‡ã‚Šä¸Šã’

          print(f"å…¨è¨˜äº‹ã‚’å–å¾—ä¸­... ({pages}ãƒšãƒ¼ã‚¸)")

          for page in range(1, pages + 1):
              response = requests.get(f"{wp_url}/wp-json/wp/v2/posts?status=publish&per_page={per_page}&page={page}")
              if response.status_code == 200:
                  posts = response.json()
                  all_posts.extend(posts)
                  print(f"  ãƒšãƒ¼ã‚¸ {page}/{pages}: {len(posts)}ä»¶å–å¾—")
              else:
                  print(f"âš  ãƒšãƒ¼ã‚¸ {page} ã®å–å¾—ã«å¤±æ•—")

          print(f"âœ“ å…¨{len(all_posts)}ä»¶ã®è¨˜äº‹ã‚’å–å¾—ã—ã¾ã—ãŸ")

          # Step 3: ãƒ©ãƒ³ãƒ€ãƒ ã«50ä»¶ã‚’é¸æŠï¼ˆç·æ•°ãŒ50ä»¶æœªæº€ã®å ´åˆã¯å…¨ä»¶ï¼‰
          sample_size = min(50, len(all_posts))
          sampled_posts = random.sample(all_posts, sample_size)
          print(f"âœ“ ãƒ©ãƒ³ãƒ€ãƒ ã«{sample_size}ä»¶ã‚’é¸æŠã—ã¾ã—ãŸ")

          # Step 4: Twitterèªè¨¼
          client = tweepy.Client(
              consumer_key=os.environ['TWITTER_API_KEY'],
              consumer_secret=os.environ['TWITTER_API_SECRET'],
              access_token=os.environ['TWITTER_ACCESS_TOKEN'],
              access_token_secret=os.environ['TWITTER_ACCESS_SECRET']
          )

          # Step 5: éå»10æŠ•ç¨¿ã®å±¥æ­´ã‚’å–å¾—ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
          try:
              me = client.get_me()
              user_id = me.data.id

              recent_tweets = client.get_users_tweets(
                  id=user_id,
                  max_results=10,
                  tweet_fields=['created_at', 'text']
              )

              posted_urls = set()
              if recent_tweets.data:
                  for tweet in recent_tweets.data:
                      import re
                      urls = re.findall(r'https?://[^\s]+', tweet.text)
                      posted_urls.update(urls)

              print(f"âœ“ éå»10æŠ•ç¨¿ã®URL: {len(posted_urls)}ä»¶")

          except Exception as e:
              print(f"âš  éå»ãƒ„ã‚¤ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—: {e}")
              posted_urls = set()

          # Step 6: éå»10æŠ•ç¨¿ã«å«ã¾ã‚Œã¦ã„ãªã„è¨˜äº‹ã‚’é¸æŠ
          available_posts = []
          for post in sampled_posts:
              post_url = post['link']
              if post_url not in posted_urls:
                  available_posts.append(post)

          if not available_posts:
              print("âš  æŠ•ç¨¿å¯èƒ½ãªæ–°ã—ã„è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆéå»10æŠ•ç¨¿ã¨é‡è¤‡ï¼‰")
              # å…¨ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡ã‚’è¨±å®¹ï¼‰
              available_posts = sampled_posts

          print(f"âœ“ æŠ•ç¨¿å¯èƒ½ãªè¨˜äº‹: {len(available_posts)}ä»¶")

          # Step 7: ãƒ©ãƒ³ãƒ€ãƒ ã«1è¨˜äº‹é¸æŠ
          selected_post = random.choice(available_posts)
          title = selected_post['title']['rendered']
          link = selected_post['link']

          print(f"é¸æŠã•ã‚ŒãŸè¨˜äº‹: {title}")
          print(f"URL: {link}")

          # å¤šæ§˜ãªæŠ•ç¨¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆè‡ªç„¶ãªæŠ•ç¨¿ã«è¦‹ã›ã‚‹ï¼‰
          patterns = [
              {
                  "emoji": "ğŸ’¡",
                  "intro": "æœ‰ç›Šæƒ…å ±ã‚’ãŠå±Šã‘",
                  "cta": "ç¶šãã¯ã“ã¡ã‚‰"
              },
              {
                  "emoji": "ğŸ“",
                  "intro": "æ°—ã«ãªã‚‹æƒ…å ±ã‚’ã‚·ã‚§ã‚¢",
                  "cta": "è©³ã—ãè¦‹ã‚‹"
              },
              {
                  "emoji": "âœ¨",
                  "intro": "æœ€è¿‘è¦‹ã¤ã‘ãŸã„ã„è¨˜äº‹",
                  "cta": "è¨˜äº‹ã‚’èª­ã‚€"
              },
              {
                  "emoji": "ğŸ”",
                  "intro": "èª¿ã¹ã¦ã¿ã¾ã—ãŸ",
                  "cta": "å…¨æ–‡ã¯ã“ã¡ã‚‰"
              },
              {
                  "emoji": "ğŸ“Œ",
                  "intro": "å‚è€ƒã«ãªã‚‹æƒ…å ±",
                  "cta": "ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦"
              },
              {
                  "emoji": "ğŸ‘€",
                  "intro": "ã“ã‚ŒçŸ¥ã£ã¦ãŸï¼Ÿ",
                  "cta": "è©³ç´°ã‚’ç¢ºèª"
              },
              {
                  "emoji": "ğŸ’¬",
                  "intro": "å…±æœ‰ã—ãŸã„æƒ…å ±",
                  "cta": "èª­ã‚“ã§ã¿ã‚‹"
              },
              {
                  "emoji": "ğŸŒŸ",
                  "intro": "å½¹ç«‹ã¡ãã†ãªæƒ…å ±",
                  "cta": "ã‚‚ã£ã¨è¦‹ã‚‹"
              },
              {
                  "emoji": "ğŸ“±",
                  "intro": "èˆˆå‘³æ·±ã„å†…å®¹",
                  "cta": "è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯"
              },
              {
                  "emoji": "ğŸ¯",
                  "intro": "ã¾ã¨ã‚ã¦ã¿ãŸ",
                  "cta": "ç¶šãã‚’èª­ã‚€"
              }
          ]

          # ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
          pattern = random.choice(patterns)
          emoji = pattern["emoji"]
          intro = pattern["intro"]
          cta = pattern["cta"]

          # ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆæŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªã„ï¼‰
          hashtag = "#ãƒ–ãƒ­ã‚°"

          tweet_text = f"{emoji} {intro}\n\n{title}\n\n{cta}\n{link}\n\n{hashtag}"

          # 280æ–‡å­—åˆ¶é™ã‚’è€ƒæ…®
          if len(tweet_text) > 280:
              # ã‚¿ã‚¤ãƒˆãƒ«ã‚’çŸ­ç¸®
              max_title_length = 280 - len(tweet_text) + len(title) - 10
              short_title = title[:max_title_length] + "..."
              tweet_text = f"{emoji} {intro}\n\n{short_title}\n\n{cta}\n{link}\n\n{hashtag}"

          # Step 9: æŠ•ç¨¿
          try:
              response = client.create_tweet(text=tweet_text)
              print(f"âœ“ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿æˆåŠŸ: {response.data['id']}")
              print(f"ãƒ„ã‚¤ãƒ¼ãƒˆURL: https://twitter.com/user/status/{response.data['id']}")
          except Exception as e:
              print(f"âŒ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ã«å¤±æ•—: {e}")
              exit(1)

          # çµæœã‚µãƒãƒªãƒ¼
          print("\n" + "=" * 50)
          print(f"3æ—¥ã«1å›ã®ãƒãƒ«ã‚¯TwitteræŠ•ç¨¿å®Œäº†")
          print(f"ç·è¨˜äº‹æ•°: {total_posts}ä»¶")
          print(f"ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«: {sample_size}ä»¶")
          print(f"æŠ•ç¨¿å¯èƒ½è¨˜äº‹æ•°: {len(available_posts)}ä»¶")
          print("=" * 50)
          EOF

      - name: æŠ•ç¨¿çµæœ
        if: success()
        run: |
          echo "âœ“ Bulk TwitteræŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "æ¬¡å›å®Ÿè¡Œ: 3æ—¥å¾Œ"
