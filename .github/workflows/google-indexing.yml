name: Google Indexing API

on:
  # WordPress投稿後に実行
  workflow_run:
    workflows: ["WordPress Auto Post"]
    types:
      - completed
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      post_url:
        description: 'インデックス登録するURL'
        required: true

jobs:
  submit-to-google:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Python環境のセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 依存関係のインストール
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: 最新記事を取得
        id: get_post
        run: |
          # WordPress REST APIから最新記事を取得
          curl -s "${{ secrets.WP_SITE_URL }}/wp-json/wp/v2/posts?per_page=1&orderby=date" > latest_post.json

          # 記事のURLを抽出
          LINK=$(cat latest_post.json | python3 -c "import sys, json; print(json.load(sys.stdin)[0]['link'])")

          echo "link=$LINK" >> $GITHUB_OUTPUT

      - name: Google Indexing APIにURL送信
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          python3 << 'EOF'
          import json
          import os
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # サービスアカウントの認証情報を取得
          credentials_json = os.environ['GOOGLE_SERVICE_ACCOUNT_JSON']
          credentials_info = json.loads(credentials_json)

          # 認証
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/indexing']
          )

          # Indexing APIクライアント
          service = build('indexing', 'v3', credentials=credentials)

          # URL送信
          url = "${{ steps.get_post.outputs.link }}"

          request_body = {
              "url": url,
              "type": "URL_UPDATED"
          }

          response = service.urlNotifications().publish(body=request_body).execute()
          print(f"✓ Google Indexing API送信成功")
          print(f"URL: {url}")
          print(f"Response: {response}")
          EOF

      - name: 送信結果
        if: success()
        run: |
          echo "✓ Google Indexing APIへの送信が完了しました"
          echo "これにより、Googleの検索結果に数時間〜数日で反映されます"
